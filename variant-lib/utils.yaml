#!/usr/bin/env variant
# vi: ft=yaml

description: Toolbox management tasks

bindParamsFromEnv: true

tasks:
  exec:
    interactive: true
    bindParamsFromEnv: true
    parameters:
    - name: hook_context
      type: string
      default: "toolbox_variant_core_exec"
    - name: TOOLBOX_DEPS_DIR
      type: string
      default: "toolbox/deps"
    - name: title
      default: "Execute command"
    - name: cmd
      default: "pwd"
    steps:
    - script: |
        # Includes
        . "{{ .TOOLBOX_DEPS_DIR }}/toolbox-utils/includes/init.sh"
        . "{{ .TOOLBOX_DEPS_DIR }}/toolbox-utils/includes/util.sh"
        . "{{ .TOOLBOX_DEPS_DIR }}/toolbox-utils/includes/log.sh"
        . "{{ .TOOLBOX_DEPS_DIR }}/toolbox-exec/includes/exec.sh"

        CMD={{ list .cmd | join " " | trimSuffix "\n" | trim | quote | replace "\\n" "\n" | replace "$" "\\$" }}

        toolbox_exec_hook "{{ .hook_context }}" "before"

        _toolbox_exec_log_cmd "{{ .title }}" "${CMD}"

        {{ .cmd }}

        toolbox_exec_hook "{{ .hook_context }}" "after"
