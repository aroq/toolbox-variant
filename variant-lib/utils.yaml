#!/usr/bin/env variant
# vi: ft=yaml

description: Toolbox management tasks

bindParamsFromEnv: true
autoenv: true

tasks:
  exec:
    interactive: true
    bindParamsFromEnv: true
    autoenv: true
    parameters:
    - name: hook_context
      type: string
      default: "toolbox_variant_core_exec"
    - name: TOOLBOX_UTILS_DIR
      type: string
      default: "toolbox/deps/toolbox-utils"
    - name: title
      default: "Execute command"
    - name: cmd
      default: "pwd"
    steps:
    - script: |
        # Includes
        . "${TOOLBOX_UTILS_DIR}/includes/init.sh"
        . "${TOOLBOX_UTILS_DIR}/includes/util.sh"
        . "${TOOLBOX_UTILS_DIR}/includes/log.sh"
        . "${TOOLBOX_UTILS_DIR}/includes/exec.sh"

        if [ "${TOOLBOX_LOG_LEVEL}" = "TRACE" ]; then set -x; fi

        CMD={{ list .cmd | join " " | trimSuffix "\n" | trim | quote | replace "\\n" "\n" | replace "$" "\\$" }}

        toolbox_exec_hook "{{ .hook_context }}" "before"

        _toolbox_exec_log_cmd "{{ .title }}" "${CMD}"


        {{ .cmd }}

        toolbox_exec_hook "{{ .hook_context }}" "after"

        if [ "${TOOLBOX_LOG_LEVEL}" = "TRACE" ]; then set +x; fi


